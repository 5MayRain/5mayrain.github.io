var xhr,Home=location.href,Pages=4,xhrUrl="",Diaspora={L:function(t,e,a){if(t==xhrUrl)return!1;xhrUrl=t,xhr&&xhr.abort(),xhr=$.ajax({type:"GET",url:t,timeout:1e4,success:function(t){e(t),xhrUrl=""},error:function(e,o,n){"abort"==o?a&&a():window.location.href=t,xhrUrl=""}})},P:function(){return!!("ontouchstart"in window)},PS:function(){window.history&&history.pushState&&(history.replaceState({u:Home,t:document.title},document.title,Home),window.addEventListener("popstate",(function(t){var e=t.state;e&&(document.title=e.t,e.u==Home?($("#preview").css("position","fixed"),setTimeout((function(){$("#preview").removeClass("show"),$("#container").show(),window.scrollTo(0,parseInt($("#container").data("scroll"))),setTimeout((function(){$("#preview").html(""),$(window).trigger("resize")}),300)}),0)):(Diaspora.loading(),Diaspora.L(e.u,(function(t){document.title=e.t,$("#preview").html($(t).filter("#single")),Diaspora.preview(),setTimeout((function(){Diaspora.player()}),0)}))))})))},HS:function(t,e){var a=t.data("id")||0,o=t.attr("href"),n=t.attr("title")+" - "+$("#config-title").text();$("#preview").length&&window.history&&history.pushState||(location.href=o),Diaspora.loading();var i={d:a,t:n,u:o};Diaspora.L(o,(function(t){if($(t).filter("#single").length){switch(e){case"push":history.pushState(i,n,o);break;case"replace":history.replaceState(i,n,o)}switch(document.title=n,$("#preview").html($(t).filter("#single")),e){case"push":Diaspora.preview();break;case"replace":window.scrollTo(0,0),Diaspora.loaded()}setTimeout((function(){Diaspora.player(),$("#top").show(),comment=$("#gitalk-container"),1==comment.data("ae")&&comment.click()}),0);var a=document.getElementById("single");MathJax.Hub.Queue(["Typeset",MathJax.Hub,a])}else location.href=o}))},preview:function(){$("#preview").one("transitionend webkitTransitionEnd oTransitionEnd otransitionend MSTransitionEnd",(function(){$("#preview").hasClass("show")?$("#container").hide():$("#container").show(),Diaspora.loaded()})),setTimeout((function(){$("#preview").addClass("show"),$("#container").data("scroll",window.scrollY),setTimeout((function(){$("#preview").css({position:"static","overflow-y":"auto"})}),500)}),0)},player:function(){var t=$("#audio");t.length?(""==$("#audio source").eq(0).attr("src")&&""==t[0].src&&(audiolist=$("#audio-list li"),mp3=audiolist.eq([Math.floor(Math.random()*audiolist.size())]),t[0].src=mp3.data("url")),1==t.eq(0).data("autoplay")&&t[0].play(),t.on({timeupdate:function(){var e=t[0].currentTime/t[0].duration*100;$(".bar").css("width",e+"%"),t[0].volume=e/5<=1?e/5:1},ended:function(){$(".icon-pause").removeClass("icon-pause").addClass("icon-play")},playing:function(){$(".icon-play").removeClass("icon-play").addClass("icon-pause")}})):$(".icon-play").css({color:"#dedede",cursor:"not-allowed"})},loading:function(){var t=window.innerWidth,e='<style class="loaderstyle" id="loaderstyle'+t+'">@-moz-keyframes loader'+t+"{100%{background-position:"+t+"px 0}}@-webkit-keyframes loader"+t+"{100%{background-position:"+t+"px 0}}.loader"+t+"{-webkit-animation:loader"+t+" 3s linear infinite;-moz-animation:loader"+t+" 3s linear infinite;}</style>";$(".loaderstyle").remove(),$("head").append(e),$("#loader").removeClass().addClass("loader"+t).show()},loaded:function(){$("#loader").removeClass().hide()},F:function(t,e,a){var o=$(t).parent().height(),n=$(t).parent().width(),i=a/e;o/n>i?(t.style.height=o+"px",t.style.width=o/i+"px"):(t.style.width=n+"px",t.style.height=n*i+"px"),t.style.left=(n-parseInt(t.style.width))/2+"px",t.style.top=(o-parseInt(t.style.height))/2+"px"}};$((function(){if(Diaspora.P()&&$("body").addClass("touch"),$("#preview").length){var t,e={};e.t=$("#cover"),e.w=e.t.attr("width"),e.h=e.t.attr("height"),(e.o=function(){$("#mark").height(window.innerHeight)})(),e.t.prop("complete")&&setTimeout((function(){e.t.load()}),0),e.t.on("load",(function(){(e.f=function(){var t,a,o,n,i=$("#mark").width(),r=$("#mark").height();n=i>=1e3||r>=1e3?1e3:500,i>=r?(a=o=i/n*50,t=o*i/r):(t=o=r/n*50,a=o*r/i),$(".layer").css({width:i+t,height:r+a,marginLeft:-.5*t,marginTop:-.5*a}),e.w||(e.w=e.t.width(),e.h=e.t.height()),Diaspora.F($("#cover")[0],e.w,e.h)})(),setTimeout((function(){$("html, body").removeClass("loading")}),1e3),$("#mark").parallax();var t=new Vibrant(e.t[0]).swatches();t.DarkVibrant&&($("#vibrant polygon").css("fill",t.DarkVibrant.getHex()),$("#vibrant div").css("background-color",t.DarkVibrant.getHex())),t.Vibrant&&($(".icon-menu").css("color",t.Vibrant.getHex()),$(".icon-search").css("color",t.Vibrant.getHex()))})),e.t.attr("src")||alert("Please set the post thumbnail"),$("#preview").css("min-height",window.innerHeight),Diaspora.PS(),$(".pview a").addClass("pviewa"),$(window).on("resize",(function(){clearTimeout(t),t=setTimeout((function(){Diaspora.P()||location.href!=Home||(e.o(),e.f()),$("#loader").attr("class")&&Diaspora.loading()}),500)}))}else $("#single").css("min-height",window.innerHeight),setTimeout((function(){$("html, body").removeClass("loading")}),1e3),window.addEventListener("popstate",(function(t){t.state&&(location.href=t.state.u)})),Diaspora.player(),$(".icon-icon, .image-icon").attr("href","/"),$("#top").show();$(window).on("scroll",(function(){if($(".scrollbar").length&&!Diaspora.P()&&!$(".icon-images").hasClass("active")){var t=$(window).scrollTop(),e=$("#top").width()/(document.body.scrollHeight-$(window).height())*t;$(".scrollbar").width(e),t>80&&window.innerWidth>800?$(".subtitle").fadeIn():$(".subtitle").fadeOut()}})),$(window).on("touchmove",(function(t){$("body").hasClass("mu")&&t.preventDefault()}));var a=function(t,e,a){"use strict";$.ajax({url:t,dataType:"xml",success:function(t){var o=$("entry",t).map((function(){return{title:$("title",this).text(),content:$("content",this).text(),url:$("url",this).text()}})).get(),n=document.getElementById(e),i=document.getElementById(a);n.addEventListener("input",(function(){var t='<ul class="search-result-list">',e=this.value.trim().toLowerCase().split(/[\s\-]+/);i.innerHTML="",this.value.trim().length<=0||(o.forEach((function(a){var o=!0,n=a.title.trim().toLowerCase(),i=a.content.trim().replace(/<[^>]+>/g,"").toLowerCase(),r=a.url,s=-1,l=-1,c=-1;if(""!=n&&""!=i&&e.forEach((function(t,e){s=n.indexOf(t),l=i.indexOf(t),s<0&&l<0?o=!1:(l<0&&(l=0),0==e&&(c=l))})),o){t+="<li><a href='"+r+"' class='search-result-title' target='_blank'>"+n+"</a>";var d=a.content.trim().replace(/<[^>]+>/g,"");if(c>=0){var u=c-6,h=c+6;u<0&&(u=0),0==u&&(h=10),h>d.length&&(h=d.length);var p=d.substr(u,h);e.forEach((function(t){var e=new RegExp(t,"gi");p=p.replace(e,'<em class="search-keyword">'+t+"</em>")})),t+='<p class="search-result">'+p+"...</p>"}}})),i.innerHTML=t)}))}})},o="/search.xml";null!==document.getElementById("local-search-input")&&a(o,"local-search-input","local-search-result");var n=null;$("body").on("click",(function(t){var e=$(t.target).attr("class")||"",i=$(t.target).attr("rel")||"";if("IMG"==t.target.nodeName&&$(t.target).parents("div.content").length>0&&(e="pimg"),e||i)switch(!0){case-1!=e.indexOf("switchmenu"):return window.scrollTo(0,0),$("html, body").toggleClass("mu"),null!==n?(n.destroy(),n=null):1==$("#hitokoto").data("st")&&$.get("https://v1.hitokoto.cn/",(function(t){var e={strings:[(t=t).hitokoto+" ——  By "+t.from],typeSpeed:90,startDelay:500};n=new Typed(".hitokoto .typed",e)})),!1;case-1!=e.indexOf("switchsearch"):return $("body").removeClass("mu"),null!==n&&(n.destroy(),n=null),setTimeout((function(){Diaspora.HS($(t.target),"push"),$(".toc").fadeIn(1e3),a(o,"local-search-input","local-search-result")}),300),!1;case-1!=e.indexOf("more"):if("loading"==(e=$(".more")).data("status"))return!1;var r=parseInt(e.data("page"))||1;if(1==r&&e.data("page",1),r>=Pages)return;return e.html("加载中...").data("status","loading"),Diaspora.loading(),Diaspora.L(e.attr("href"),(function(t){var a=$(t).find(".more").attr("href");null!=a?(e.attr("href",a).html("加载更多").data("status","loaded"),e.data("page",parseInt(e.data("page"))+1)):$("#pager").remove();var o=$(window).scrollTop();$("#primary").append($(t).find(".post")),$(window).scrollTop(o+100),Diaspora.loaded(),$("html,body").animate({scrollTop:o+400},500)}),(function(){e.html("加载更多").data("status","loaded")})),!1;case-1!=e.indexOf("icon-home"):return $(".toc").fadeOut(100),$("#preview").hasClass("show")?history.back():location.href=$(".icon-home").data("url"),!1;case-1!=e.indexOf("icon-scan"):return $(".icon-scan").hasClass("tg")?$("#qr").toggle():($(".icon-scan").addClass("tg"),$("#qr").qrcode({width:128,height:128,text:location.href}).toggle()),!1;case-1!=e.indexOf("icon-play"):return $("#audio")[0].play(),$(".icon-play").removeClass("icon-play").addClass("icon-pause"),!1;case-1!=e.indexOf("icon-pause"):return $("#audio")[0].pause(),$(".icon-pause").removeClass("icon-pause").addClass("icon-play"),!1;case-1!=e.indexOf("cover"):return Diaspora.HS($(t.target).parent(),"push"),!1;case-1!=e.indexOf("posttitle"):return Diaspora.HS($(t.target),"push"),!1;case"prev"==i||"next"==i:if("prev"==i)var s=$("#prev_next a")[0].text;else s=$("#prev_next a")[1].text;return $(t.target).attr("title",s),Diaspora.HS($(t.target),"replace"),!1;case-1!=e.indexOf("toc-text")||-1!=e.indexOf("toc-link")||-1!=e.indexOf("toc-number"):return hash="","SPAN"==t.target.nodeName?hash=$(t.target).parent().attr("href"):hash=$(t.target).attr("href"),to=$(decodeURI(hash)),$("html,body").animate({scrollTop:to.offset().top-50},300),!1;case-1!=e.indexOf("pviewa"):return $("body").removeClass("mu"),null!==n&&(n.destroy(),n=null),setTimeout((function(){Diaspora.HS($(t.target),"push"),$(".toc").fadeIn(1e3)}),300),!1;case-1!=e.indexOf("pimg"):var l=$(".pswp").get(0);if(l){var c=[],d=0,u=[];$(".content img").each((function(e,a){t.target.src==a.src&&(d=e);var o={src:a.src,w:a.naturalWidth,h:a.naturalHeight};u.push(a),c.push(o)}));var h={index:d,shareEl:!1,zoomEl:!1,allowRotationOnUserZoom:!0,history:!1,getThumbBoundsFn:function(t){var e=u[t],a=window.pageYOffset||document.documentElement.scrollTop,o=e.getBoundingClientRect();return{x:o.left,y:o.top+a,w:o.width}}};new PhotoSwipe(l,PhotoSwipeUI_Default,c,h).init()}return!1;case-1!=e.indexOf("comment"):return 1==$("#gitalk-container").data("enable")?(Diaspora.loading(),comment=$("#gitalk-container"),gitalk=new Gitalk({clientID:comment.data("ci"),clientSecret:comment.data("cs"),repo:comment.data("r"),owner:comment.data("o"),admin:comment.data("a"),id:decodeURI(window.location.pathname),distractionFreeMode:comment.data("d")}),$(".comment").removeClass("link"),gitalk.render("gitalk-container"),Diaspora.loaded()):$("#gitalk-container").html("评论已关闭"),!1;default:return!0}})),comment=$("#gitalk-container"),1==comment.data("ae")&&comment.click(),console.log("%c Github %c","background:#24272A; color:#ffffff","","https://github.com/Fechin/hexo-theme-diaspora")}));